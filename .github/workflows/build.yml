name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixpkgs-unstable

      - name: Build Nix package
        run: nix build

      - name: Build all packages
        run: |
          nix develop --command bash -c "
            nfpm package -p deb
            nfpm package -p rpm
            nfpm package -p apk
            nfpm package -p archlinux
            python -m build
          "

      - name: Upload deb
        uses: actions/upload-artifact@v4
        with:
          name: deb
          path: "*.deb"

      - name: Upload rpm
        uses: actions/upload-artifact@v4
        with:
          name: rpm
          path: "*.rpm"

      - name: Upload apk
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: "*.apk"

      - name: Upload archlinux
        uses: actions/upload-artifact@v4
        with:
          name: archlinux
          path: "*.pkg.tar.zst"

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel
          path: dist/*.whl

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  build-snap:
    name: Build Snap
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Snap
        uses: snapcore/action-build@v1
        id: snap
        with:
          snapcraft-channel: 8.x/stable

      - name: Upload Snap
        uses: actions/upload-artifact@v4
        with:
          name: snap
          path: ${{ steps.snap.outputs.snap }}

  build-flatpak:
    name: Build Flatpak
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:freedesktop-24.08
      options: --privileged
    steps:
      - uses: actions/checkout@v4

      - name: Build Flatpak
        uses: flathub-infra/flatpak-github-actions/flatpak-builder@master
        with:
          manifest-path: flatpak/com.github.whispaste.yml
          bundle: whispaste.flatpak
          upload-artifact: false

      - name: Upload Flatpak
        uses: actions/upload-artifact@v4
        with:
          name: flatpak
          path: whispaste.flatpak

  build-appimage:
    name: Build AppImage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixpkgs-unstable

      - name: Build AppImage
        run: |
          chmod +x scripts/make-appimage.sh
          ./scripts/make-appimage.sh

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: appimage
          path: "*.AppImage"

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-snap, build-flatpak, build-appimage]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Flatten artifacts
        run: |
          mkdir -p release
          find artifacts -type f \( \
            -name "*.deb" -o \
            -name "*.rpm" -o \
            -name "*.apk" -o \
            -name "*.pkg.tar.zst" -o \
            -name "*.whl" -o \
            -name "*.tar.gz" -o \
            -name "*.snap" -o \
            -name "*.flatpak" -o \
            -name "*.AppImage" \
          \) -exec mv {} release/ \;
          ls -la release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build-linux]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      id-token: write
    steps:
      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: wheel
          path: dist/

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

  update-homebrew:
    name: Update Homebrew tap
    runs-on: ubuntu-latest
    needs: [release]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Get release info
        id: release
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          SHA256=$(curl -sL "https://github.com/kanielrkirby/whispaste/archive/refs/tags/v${VERSION}.tar.gz" | sha256sum | cut -d' ' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

      - name: Update Homebrew formula
        uses: mislav/bump-homebrew-formula-action@v3
        with:
          formula-name: whispaste
          formula-path: whispaste.rb
          homebrew-tap: kanielrkirby/homebrew-whispaste
          tag-name: ${{ github.ref_name }}
          download-url: https://github.com/kanielrkirby/whispaste/archive/refs/tags/${{ github.ref_name }}.tar.gz
        env:
          COMMITTER_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
