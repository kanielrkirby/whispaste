name: Test Packages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-packages:
    name: Build packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixpkgs-unstable

      - name: Build Nix package
        run: nix build

      - name: Build all packages
        run: |
          nix develop --command bash -c "
            nfpm package -p deb
            nfpm package -p rpm
            nfpm package -p apk
            nfpm package -p archlinux
            python -m build
          "

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: |
            *.deb
            *.rpm
            *.apk
            *.pkg.tar.zst
            dist/*.whl
            dist/*.tar.gz

  test-packages:
    name: Test package installations
    runs-on: ubuntu-latest
    needs: build-packages
    steps:
      - uses: actions/checkout@v4

      - name: Download packages
        uses: actions/download-artifact@v4
        with:
          name: packages

      - name: Move dist files
        run: |
          mkdir -p dist
          mv *.whl dist/ 2>/dev/null || true
          mv *.tar.gz dist/ 2>/dev/null || true

      - name: Run package tests
        run: ./tests/test-packages.sh

  test-syntax:
    name: Validate manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate Flatpak manifest
        run: |
          python3 -c "import yaml; yaml.safe_load(open('flatpak/com.github.whispaste.yml'))"

      - name: Validate Snap manifest
        run: |
          python3 -c "import yaml; yaml.safe_load(open('snap/snapcraft.yaml'))"

      - name: Validate Homebrew formula
        run: |
          ruby -c homebrew/whispaste.rb

      - name: Validate nfpm config
        run: |
          python3 -c "import yaml; yaml.safe_load(open('nfpm.yaml'))"

  test-macos:
    name: Test on macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install portaudio
        run: brew install portaudio

      - name: Install whispaste
        run: pip install .

      - name: Verify installation
        run: |
          which whispaste
          python -c "import whispaste; print('Import OK')"

      - name: Test clipboard backend
        run: |
          echo "test" | pbcopy
          [ "$(pbpaste)" = "test" ] && echo "Clipboard OK"

  test-windows:
    name: Test on Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install whispaste
        run: pip install .

      - name: Verify installation
        run: |
          where whispaste
          python -c "import whispaste; print('Import OK')"

      - name: Test clipboard backend
        shell: pwsh
        run: |
          "test" | Set-Clipboard
          $clip = Get-Clipboard
          if ($clip -eq "test") { Write-Host "Clipboard OK" }
